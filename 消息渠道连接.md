# 消息渠道连接文档

## 1. 概述

newbot 通过 WebSocket 协议提供实时消息渠道连接服务。客户端可以通过 WebSocket 连接到服务器，发送消息并接收 Agent 的流式响应。同时，服务器提供 HTTP API 端点，允许 Agent 通过技能脚本向指定客户端发送消息。

## 2. 连接端点

### WebSocket 端点

```
ws://{HOST}:{PORT}/ws/{client_id}
```

| 参数 | 类型 | 说明 |
|------|------|------|
| `client_id` | string | 客户端唯一标识符，用于区分不同连接 |

**默认地址：** `ws://127.0.0.1:8000/ws/{client_id}`

## 3. 消息格式

### 3.1 客户端发送消息

客户端通过 WebSocket 发送 JSON 格式消息：

```json
{
  "multimodal": [
    {
      "type": "text",
      "text": "你好，请帮我分析一下项目结构"
    }
  ],
  "audio": null
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `multimodal` | `array<dict>` | 否 | 多模态内容数组，支持文本、视觉内容（图片），不包含音频 |
| `audio` | `string \| null` | 否 | Base64 编码的音频数据（PCM 格式，16kHz、16bit、单声道） |

**multimodal 内容格式：**

```json
// 文本内容
{"type": "text", "text": "消息内容"}

// 图片内容（Base64）
{"type": "image", "source": {"type": "base64", "media_type": "image/png", "data": "base64_encoded_data"}}
```

### 3.2 服务器响应

服务器以流式方式返回 Agent 生成的 token，客户端通过监听 WebSocket 消息接收：

```python
# 伪代码示例
async for message in websocket:
    print(message)  # 每个 token 内容
```

## 4. 连接管理

### 4.1 连接生命周期

```
┌─────────┐                    ┌─────────┐                    ┌─────────┐
│  客户端  │                    │  服务器  │                    │  Agent  │
└────┬────┘                    └────┬────┘                    └────┬────┘
     │                              │                              │
     │  WebSocket 连接请求          │                              │
     │─────────────────────────────>│                              │
     │                              │                              │
     │                              │  检查 client_id 是否已存在    │
     │                              │─────────┐                    │
     │                              │         │                    │
     │                              │<────────┘                    │
     │                              │                              │
     │         [首次连接]            │                              │
     │                              │                              │
     │  接受连接                    │                              │
     │<─────────────────────────────│                              │
     │                              │                              │
     │  发送消息(JSON)              │                              │
     │─────────────────────────────>│                              │
     │                              │  调用 Agent 处理             │
     │                              │─────────────────────────────>│
     │                              │                              │
     │                              │  流式返回 token              │
     │                              │<─────────────────────────────│
     │                              │                              │
     │  转发 token                  │                              │
     │<─────────────────────────────│                              │
     │                              │                              │
     │  断开连接                    │                              │
     │─────────────────────────────>│                              │
     │                              │  从活跃连接中移除             │
     │                              │─────────┐                    │
     │                              │         │                    │
     │                              │<────────┘                    │
     │                              │                              │
```

### 4.2 重复连接拒绝

服务器拒绝同一 `client_id` 的重复连接：

- **关闭码：** `4000`
- **关闭原因：** `"已存在连接"`

客户端应处理此情况，例如：

```javascript
websocket.onclose = (event) => {
    if (event.code === 4000) {
        console.log("连接被拒绝：已存在相同 client_id 的连接");
    }
};
```

## 5. HTTP API 端点

以下 HTTP 端点供 Agent 通过技能调用，实现跨渠道消息发送。

### 5.1 获取活跃连接列表

```http
GET /get_channel_id
```

**响应示例：**

```json
["client_001", "client_002", "mobile_device"]
```

### 5.2 向指定客户端发送消息

```http
POST /send_message
Content-Type: application/json

{
  "context": "这是要发送的消息内容",
  "channel_id": "client_001"
}
```

**请求体字段：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `context` | `string` | 是 | 要发送的消息内容 |
| `channel_id` | `string` | 是 | 目标客户端 ID |

**响应：**

| 情况 | 响应内容 |
|------|----------|
| 成功 | `"成功"` |
| 频道不存在 | `"频道不存在"` |

## 6. 完整客户端示例

### Python 客户端

```python
import asyncio
import websockets
import json

async def connect_client(client_id: str):
    uri = f"ws://127.0.0.1:8000/ws/{client_id}"
    
    async with websockets.connect(uri) as websocket:
        print(f"已连接: {client_id}")
        
        # 发送消息
        message = {
            "multimodal": [
                {"type": "text", "text": "你好，请介绍一下你自己"}
            ],
            "audio": None
        }
        await websocket.send(json.dumps(message))
        
        # 接收流式响应
        while True:
            try:
                response = await websocket.recv()
                print(response, end="", flush=True)
            except websockets.exceptions.ConnectionClosed:
                break

asyncio.run(connect_client("my_client_001"))
```

### JavaScript 客户端

```javascript
const clientId = "browser_client_001";
const ws = new WebSocket(`ws://127.0.0.1:8000/ws/${clientId}`);

ws.onopen = () => {
    console.log("连接已建立");
    
    // 发送消息
    ws.send(JSON.stringify({
        multimodal: [
            { type: "text", text: "你好，请帮我分析这个文件" }
        ],
        audio: null
    }));
};

ws.onmessage = (event) => {
    // 流式接收 token
    process.stdout.write(event.data);
};

ws.onclose = (event) => {
    if (event.code === 4000) {
        console.log("连接被拒绝：已存在相同 ID 的连接");
    } else {
        console.log("连接已关闭");
    }
};

ws.onerror = (error) => {
    console.error("WebSocket 错误:", error);
};
```

## 7. 错误处理

### 7.1 WebSocket 错误码

| 错误码 | 说明 |
|--------|------|
| `4000` | 重复连接被拒绝 |
| `1011` | 服务器内部错误 |

### 7.2 服务器错误响应

当发生异常时，服务器会发送错误消息并断开连接：

```
服务器错误: <错误详情>
```

## 8. 音频消息处理

当发送包含 `audio` 字段的消息时：

1. 服务器保存音频到 `audio/` 目录
2. 调用讯飞实时语音转写服务（开启声纹分离）
3. 处理转写结果，自动识别说话人
4. 将转写文本注入消息上下文

**音频格式要求：**

- **格式：** PCM（原始音频）
- **采样率：** 16kHz
- **位深度：** 16bit
- **声道数：** 单声道
- **编码：** Base64

```json
{
  "multimodal": [],
  "audio": "UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA="
}
```

## 9. 技能调用说明

Agent 可通过 `channel-active` 技能实现跨渠道消息发送：

```bash
# 获取所有已连接客户端
python skills/skill-channel-active/scripts/get_clients.py

# 向指定客户端发送消息
python skills/skill-channel-active/scripts/send_message.py -c "client_001" -m "你好，这是来自 Agent 的消息"
```
